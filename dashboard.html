<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard | Icon Lounge SaaS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body class="bg-black text-zinc-300 flex h-screen lg:overflow-hidden">
    <!-- Mobile Backdrop: Hidden by default, visible when sidebar is open on mobile -->
    <div id="sidebarBackdrop" onclick="toggleSidebar()" class="fixed inset-0 bg-black/60 z-40 hidden lg:hidden"></div>

    <!-- Sidebar -->
    <!-- Sidebar -->
    <aside id="sidebar"
        class="fixed inset-y-0 left-0 z-50 w-64 bg-zinc-900 border-r border-zinc-800 flex flex-col transition-transform duration-300 transform -translate-x-full lg:translate-x-0 lg:static">
        <div class="p-6 border-b border-zinc-800 flex justify-between items-center">
            <img src="images/iconnlounge-logo-removebg-preview.png" class="h-8" alt="Logo">
            <button onclick="toggleSidebar()" class="lg:hidden text-zinc-500 hover:text-white">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <nav class="flex-1 p-4 space-y-2">
            <a href="dashboard.html" class="flex items-center space-x-3 p-3 rounded bg-zinc-800 text-[#d4af37]">
                <i class="fas fa-chart-line"></i> <span>Dashboard</span>
            </a>
            <a href="manage-menu.html" class="flex items-center space-x-3 p-3 rounded hover:bg-zinc-800 transition">
                <i class="fas fa-utensils"></i> <span>Menu Items</span>
            </a>
            <a href="customer-directory.html"
                class="flex items-center space-x-3 p-3 rounded hover:bg-zinc-800 transition">
                <i class="fas fa-address-book"></i> <span>Customers</span>
            </a>
            <a href="served-customers.html"
                class="flex items-center space-x-3 p-3 rounded hover:bg-zinc-800 transition">
                <i class="fas fa-user-check"></i> <span>Served Customers</span>
            </a>
            <div id="superadmin-only-nav" class="hidden">
                <a href="promotional-sms.html"
                    class="flex items-center space-x-3 p-3 rounded hover:bg-zinc-800 transition text-[#d4af37]/80">
                    <i class="fas fa-bullhorn"></i> <span>Promotions (SA)</span>
                </a>
            </div>
        </nav>
        <div class="p-4 border-t border-zinc-800">
            <button id="logoutBtn"
                class="w-full text-left flex items-center space-x-3 p-3 hover:text-red-500 transition">
                <i class="fas fa-sign-out-alt"></i> <span>Logout</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col min-h-0 overflow-hidden">
        <header class="h-16 border-b border-zinc-800 flex items-center justify-between px-4 lg:px-8 bg-zinc-900">
            <button onclick="toggleSidebar()" class="lg:hidden text-[#d4af37] mr-4">
                <i class="fas fa-bars text-xl"></i>
            </button>
            <h1 class="text-xl font-bold">Dashboard Overview</h1>
            <div id="userEmail" class="text-sm text-zinc-500"></div>
        </header>
        <section class="p-8 overflow-y-auto flex-1">
            <!-- Top Stats Cards -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="bg-zinc-900 p-6 rounded-lg border border-zinc-800">
                    <p class="text-zinc-500 text-xs uppercase font-bold">Total Customers</p>
                    <h3 id="stat-customers" class="text-3xl font-bold text-white">--</h3>
                </div>
                <div class="bg-zinc-900 p-6 rounded-lg border border-zinc-800">
                    <p class="text-zinc-500 text-xs uppercase font-bold">Menu Categories</p>
                    <h3 id="stat-categories" class="text-3xl font-bold text-zinc-400">--</h3>
                </div>
                <div class="bg-zinc-900 p-6 rounded-lg border border-zinc-800">
                    <p class="text-zinc-500 text-xs uppercase font-bold">SMS Sent (Sent)</p>
                    <h3 id="stat-sms-sent" class="text-3xl font-bold text-[#d4af37]">--</h3>
                </div>
                <div class="bg-zinc-900 p-6 rounded-lg border border-zinc-800">
                    <p class="text-zinc-500 text-xs uppercase font-bold">Failed Messages</p>
                    <h3 id="stat-sms-failed" class="text-3xl font-bold text-red-500">--</h3>
                </div>

            </div>

            <!-- Charts Row 1 -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
                <div class="bg-zinc-900 p-6 rounded-lg border border-zinc-800">
                    <h4 class="text-sm font-bold mb-4 text-zinc-400 uppercase">SMS Delivery Status</h4>
                    <div class="h-64 flex justify-center">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
                <div class="bg-zinc-900 p-6 rounded-lg border border-zinc-800">
                    <h4 class="text-sm font-bold mb-4 text-zinc-400 uppercase">Daily Message Volume (Last 7 Days)</h4>
                    <div class="h-64">
                        <canvas id="volumeChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Charts Row 2 -->
            <div class="bg-zinc-900 p-6 rounded-lg border border-zinc-800">
                <h4 class="text-sm font-bold mb-4 text-zinc-400 uppercase">Customer Growth (Monthly)</h4>
                <div class="h-64">
                    <canvas id="growthChart"></canvas>
                </div>
            </div>
        </section>
    </main>

    <script src="admin-config.js"></script>
    <script>
        // Auth Guard and Basic Logic
        async function initDashboard() {
            const user = await checkAuth();
            if (!user) return;
            document.getElementById('userEmail').innerText = user.email;

            // RBAC Check for Sidebar
            const { data: profile } = await _supabase.from('profiles').select('role').eq('id', user.id).single();
            if (profile?.role === 'superadmin') {
                document.getElementById('superadmin-only-nav')?.classList.remove('hidden');
            }

            // 1. Fetch Basic Counts
            const { count: custCount } = await _supabase.from('customers').select('*', { count: 'exact', head: true });
            const { count: catCount } = await _supabase.from('categories').select('*', { count: 'exact', head: true });
            const { count: sentCount } = await _supabase.from('sms_logs').select('*', { count: 'exact', head: true }).eq('status', 'sent');
            const { count: failedCount } = await _supabase.from('sms_logs').select('*', { count: 'exact', head: true }).eq('status', 'failed');

            document.getElementById('stat-customers').innerText = custCount || 0;
            document.getElementById('stat-categories').innerText = catCount || 0;
            document.getElementById('stat-sms-sent').innerText = sentCount || 0;
            document.getElementById('stat-sms-failed').innerText = failedCount || 0;

            // 2. Fetch Data for Charts
            renderCharts();
        }

        document.getElementById('logoutBtn').addEventListener('click', async () => {
            await _supabase.auth.signOut();
            window.location.href = 'login.html';
        });

        async function renderCharts() {
            // A. DELIVERY STATUS CHART
            const { data: statusData } = await _supabase.from('sms_logs').select('status');
            const counts = { sent: 0, failed: 0, pending: 0 };
            statusData.forEach(row => counts[row.status]++);

            new Chart(document.getElementById('statusChart'), {
                type: 'doughnut',
                data: {
                    labels: ['Sent', 'Failed', 'Pending'],
                    datasets: [{
                        data: [counts.sent, counts.failed, counts.pending],
                        backgroundColor: ['#d4af37', '#ef4444', '#3f3f46'],
                        borderWidth: 0
                    }]
                },
                options: { responsive: true,maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
            });

            // B. DAILY VOLUME (Last 7 Days)
            const { data: logs } = await _supabase.from('sms_logs').select('created_at').gte('created_at', new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString());

            const days = {};
            for (let i = 6; i >= 0; i--) {
                const date = new Date(Date.now() - i * 24 * 60 * 60 * 1000).toLocaleDateString('en-US', { weekday: 'short' });
                days[date] = 0;
            }
            logs.forEach(l => {
                const day = new Date(l.created_at).toLocaleDateString('en-US', { weekday: 'short' });
                if (days[day] !== undefined) days[day]++;
            });

            new Chart(document.getElementById('volumeChart'), {
                type: 'line',
                data: {
                    labels: Object.keys(days),
                    datasets: [{
                        label: 'SMS Sent',
                        data: Object.values(days),
                        borderColor: '#d4af37',
                        tension: 0.4,
                        fill: true,
                        backgroundColor: 'rgba(212, 175, 55, 0.1)'
                    }]
                },
                options: { responsive: true,maintainAspectRatio: false, scales: { y: { beginAtZero: true, grid: { color: '#27272a' } } } }
            });
        }

        initDashboard();
    </script>
</body>

</html>